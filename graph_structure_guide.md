# Руководство по работе с графовой структурой знаний

## Введение

Графовая структура знаний в Банке Памяти представляет собой мощный инструмент для моделирования и запроса сложных взаимосвязей между элементами проекта. Этот документ описывает, как эффективно использовать эту функциональность в контексте протокола RIPER и Банка Памяти.

## Структура графа знаний

### Основные элементы

1. **Узлы (Nodes)** - представляют сущности в проекте
   - Каждый узел имеет уникальный ID
   - Тип узла (например, Function, File, Concept, Component)
   - Человекочитаемая метка
   - Опциональные структурированные данные
   - Метаданные (дата создания, последнего обновления, версия)

2. **Ребра (Edges)** - представляют отношения между узлами
   - Направленные связи от исходного узла к целевому
   - Тип отношения (например, CALLS, IMPLEMENTS, DEPENDS_ON)
   - Метаданные (дата создания, последнего обновления, версия)

### Метаданные графа

Граф содержит следующие метаданные:
- Timestamp последнего сохранения
- Количество узлов и ребер
- Версия графа
- Дополнительная информация о состоянии

## Типичные сценарии использования графа

### 1. Моделирование архитектуры
   - Создание узлов для компонентов системы
   - Определение зависимостей между компонентами через ребра
   - Запрос для визуализации архитектуры системы

### 2. Отслеживание функциональных зависимостей
   - Моделирование функций как узлов
   - Создание ребер типа CALLS между вызывающими и вызываемыми функциями
   - Запрос для анализа потенциального воздействия изменений

### 3. Концептуальное моделирование
   - Создание узлов для ключевых концепций проекта
   - Связывание концепций с их реализациями в коде
   - Запрос для понимания, как абстрактные концепции воплощаются в коде

### 4. Отслеживание требований
   - Моделирование требований как узлов
   - Связывание требований с компонентами, которые их реализуют
   - Запрос для проверки покрытия требований

## Инструменты для работы с графом

### Пакетные операции

1. **mcp_memory_bank_batch_add**
   ```typescript
   Параметры:
   - project_name: имя проекта
   - nodes: массив узлов для добавления
     - id: уникальный идентификатор узла
     - type: тип узла
     - label: человекочитаемая метка
     - data: (опционально) структурированные данные
   - edges: массив ребер для добавления
     - sourceId: идентификатор исходного узла
     - targetId: идентификатор целевого узла
     - relationshipType: тип отношения
   - silent_mode: (опционально) не выдавать ошибки для существующих элементов
   ```

2. **mcp_memory_bank_batch_update**
   ```typescript
   Параметры:
   - project_name: имя проекта
   - nodes: массив узлов для обновления
     - id: идентификатор узла
     - newLabel: (опционально) новая метка
     - data: (опционально) данные для объединения
   - silent_mode: (опционально) не выдавать ошибки для отсутствующих узлов
   ```

3. **mcp_memory_bank_batch_delete**
   ```typescript
   Параметры:
   - project_name: имя проекта
   - nodeIds: (опционально) массив ID узлов для удаления
   - edges: (опционально) массив ребер для удаления
     - sourceId: идентификатор исходного узла
     - targetId: идентификатор целевого узла
     - relationshipType: (опционально) тип отношения
   - silent_mode: (опционально) не выдавать ошибки для отсутствующих элементов
   ```

### Поиск и запросы

1. **mcp_memory_bank_search_graph**
   ```typescript
   Параметры:
   - project_name: имя проекта
   - query: строка поиска
   - search_in: массив атрибутов для поиска (id, type, label, data)
   - case_sensitive: учитывать регистр
   - limit: максимальное количество результатов
   ```

2. **mcp_memory_bank_query_graph**
   ```typescript
   Параметры:
   - project_name: имя проекта
   - query: объект запроса
     - filters: массив фильтров по атрибутам узлов
     - neighborsOf: ID узла для поиска соседей
     - relationshipType: фильтр по типу отношения
     - direction: направление (in, out, both)
   ```

3. **mcp_memory_bank_open_nodes**
   ```typescript
   Параметры:
   - project_name: имя проекта
   - node_ids: массив ID узлов
   - include_relations: включать связи между запрошенными узлами
   ```

## Примеры использования

### Пакетное добавление компонентов и зависимостей

```typescript
// Добавление компонентов и их зависимостей
await mcp_memory_bank_batch_add({
  project_name: "MyProject",
  nodes: [
    {
      id: "auth-service",
      type: "Component",
      label: "Authentication Service",
      data: { description: "Handles user authentication" }
    },
    {
      id: "user-service",
      type: "Component",
      label: "User Service",
      data: { description: "Manages user data" }
    }
  ],
  edges: [
    {
      sourceId: "user-service",
      targetId: "auth-service",
      relationshipType: "DEPENDS_ON"
    }
  ]
});
```

### Поиск компонентов и их зависимостей

```typescript
// Поиск всех компонентов, зависящих от auth-service
const result = await mcp_memory_bank_query_graph({
  project_name: "MyProject",
  query: {
    neighborsOf: "auth-service",
    direction: "in",
    relationshipType: "DEPENDS_ON",
    filters: [
      { attribute: "type", value: "Component" }
    ]
  }
});
```

### Обновление метаданных компонентов

```typescript
// Обновление информации о компонентах
await mcp_memory_bank_batch_update({
  project_name: "MyProject",
  nodes: [
    {
      id: "auth-service",
      data: { 
        version: "2.0.0",
        status: "stable"
      }
    }
  ]
});
```

## Рекомендации по моделированию

### Типы узлов

- **File**: Представляет физический файл в проекте
  - Data: path, lastModified, fileType
- **Function**: Представляет функцию или метод
  - Data: signature, returnType, parameters
- **Class**: Представляет класс или структуру данных
  - Data: properties, methods, inheritance
- **Component**: Представляет логический компонент системы
  - Data: version, status, dependencies
- **Concept**: Представляет абстрактную концепцию или паттерн
  - Data: description, examples, references
- **Requirement**: Представляет функциональное или нефункциональное требование
  - Data: priority, status, description

### Типы отношений

- **CONTAINS**: Указывает, что один элемент содержит другой
- **CALLS**: Указывает, что функция вызывает другую функцию
- **IMPLEMENTS**: Указывает, что компонент реализует концепцию или требование
- **DEPENDS_ON**: Указывает зависимость между компонентами
- **EXTENDS**: Указывает отношение наследования
- **RELATES_TO**: Общее отношение, указывающее на связь между элементами

## Миграция со старой версии

### Изменения в API

1. Замена отдельных операций на пакетные:
   - Старые операции (`add_node`, `update_node`, `add_edge` и т.д.) удалены
   - Используйте `batch_add`, `batch_update`, `batch_delete` для групповых операций

2. Новые возможности:
   - Метаданные на уровне графа, узлов и ребер
   - Расширенные возможности поиска и запросов
   - Улучшенная обработка ошибок с режимом silent_mode

### Пример миграции кода

Старый код:
```typescript
await mcp_memory_bank_add_node(project, id, type, label);
await mcp_memory_bank_add_node(project, id2, type2, label2);
await mcp_memory_bank_add_edge(project, id, id2, "DEPENDS_ON");
```

Новый код:
```typescript
await mcp_memory_bank_batch_add({
  project_name: project,
  nodes: [
    { id, type, label },
    { id: id2, type: type2, label: label2 }
  ],
  edges: [
    { sourceId: id, targetId: id2, relationshipType: "DEPENDS_ON" }
  ]
});
```

## Заключение

Новая версия графовой структуры знаний предоставляет более эффективные инструменты для работы с графом, включая пакетные операции, расширенные возможности поиска и метаданные. Использование этих возможностей позволяет лучше организовать знания о проекте и эффективнее работать с ними.